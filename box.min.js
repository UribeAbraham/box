(function($,W,u){$.fn.box=function(m){var defaults={width:0,height:0,ref:!1,title:!1,closebutton:!0,type:"img",caption:!1,onStart:!1,onLoad:!1,onClose:!1,onError:!1},b=$("body"),w=$(W),methods={init:function(o){o=$.extend({},defaults,o||{});return this.each(function(){var g,s,x,e=this,z,l=$("<div class='loading'>"),v=$("<div class='box'>"),i=$(Image()),y=$("<div class='boxcontent'>"),c=$("<span class='close'>"),t=$.extend({},o),a=function(){l.fadeOut("fast",function(){l.remove()});},d=function(){if(t.closebutton){y.append(c);t.closebutton=c;}},f=function(){if(t.caption&&t.title){y.append(z);t.title=z;}},p=function(){x&&x.promise?x.done(function(){$.isFunction(t.onLoad)&&t.onLoad(t)}):$.isFunction(t.onLoad)&&t.onLoad(t);};t.ref=$(e).attr("href")||t.ref;t.title=$(e).attr("title")||t.title;z=$("<p class='caption'>"+t.title+"</p>");c.click(function(){$(e).box("close");});b.css("overflow")==""?(b.css("overflow-x")!=""&&(t.overflowx=b.css("overflow-x")),b.css("overflow-y")!=""&&(t.overflowy=b.css("overflow-y"))):t.overflow=b.css("overflow");b.append(v).css("overflow","hidden");v.css({top:w.scrollTop(),left:w.scrollLeft()}).click(function(){$(e).box("close");});t.overlay=v;v.append(l,y);l.css({display:"block",position:"absolute",left:(w.width()/2)-(l.width()/2),top:(w.height()/2)-(l.height()/2)}).click(function(e){e.stopPropagation();});w.resize(function(){l.css({left:(w.width()/2)-(l.width()/2),top:(w.height()/2)-(l.height()/2)});});t.loading=l;y.click(function(e){e.stopPropagation();});t.container=y;if($.isFunction(t.onStart)){x=t.onStart(t);}if(t.type=="img"){i.load(function(){a();y.append(i);t.image=i;d();f();s=w.height()/2;if(t.width==0&&t.height==0){t.width=this.width;t.height=this.height;g=function(){s=w.height()/2;w.width()<t.width?(y.css({width:"90%",height:"auto"}),i.css({width:"100%",height:"auto"}),y.css({top:function(){return s-y.height()/2},height:y.height()}),i.css({height:"100%"}),i.height()>w.height()&&(y.css({height:"90%",top:function(){return s-y.height()/2}}),i.css({height:"100%",width:"auto"}),y.css({width:i.width()}))):w.height()<t.height?(y.css({height:"90%",top:function(){return s-y.height()/2}}),i.css({height:"100%",width:"auto"}),y.css({width:i.width()}),i.css({width:"100%"}),i.width()>w.width()&&(y.css({width:"90%",height:"auto"}),i.css({width:"100%",height:"auto"}),y.css({top:function(){return s-y.height()/2}}))):(y.css({width:t.width,height:t.height,top:function(){return s-t.height/2}}),i.css({width:"100%",height:"100%"}));};g();w.resize(function(){g();});}else{i.css({width:t.width!=0?t.width:"auto",height:t.height!=0?t.height:"auto"});y.css({width:i.width(),height:i.height()});v.css("overflow","auto");y.css({top:y.height()>w.height()?"0px":s-(y.height()/2)});w.resize(function(){y.css({top:(w.height()/2)-y.height()/2})});}p();}).attr({src: t.ref}).error(function(){a();var r;$.isFunction(t.onError)?t.onError(t):(y.html("Error").addClass("error").css({display:""}),r=$(this).height()/2,y.css({top:(w.height()/2)-r}),d(),w.resize(function(){y.css({top:(w.height()/2)-r})}));});}else if(t.type="html"){d();var q=$("<span>");y.append(q);q.load(t.ref, function(r, j, h) {a();j=="error"&&q.html("Sorry but there was an error: "+h.status+" "+h.statusText);p();});f();}e.box=t;});},close:function(){return this.each(function(){var n=this.box,x,k=function(){n.overflow?b.css("overflow",n.overflow):b.css({"overflow-x":n.overflowx,"overflow-y":n.overflowy});n.overlay.remove();};$.isFunction(n.onClose)?(x=n.onClose(n),x&&x.promise?x.done(function(){k()}):k()):k();});}};if(methods[m]){return methods[m].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof m==='object'||!m){return methods.init.apply(this,arguments);}else{$.error('Method '+m+' does not exist on jQuery.box');}};})(jQuery,window);